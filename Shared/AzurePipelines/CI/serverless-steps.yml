parameters:
  awsCredentials: ''
  artifactName: ''
  productCode: ''
  regionName: ''
  solutionRoot: ''
  stages: []

steps:
  - script: |
      yarn
    workingDirectory:  ${{parameters.solutionRoot}}
    displayName: 'yarn install'

  - ${{ each stage in parameters.stages }}:
      - script: npx serverless package --stage=${{stage}}
        env:
          SOURCE_VERSION: $(Build.SourceVersion)
        workingDirectory: ${{parameters.solutionRoot}}
        displayName: 'serverless package ${{stage}}'

      - task: CopyFiles@2
        inputs:
          SourceFolder: '${{parameters.solutionRoot}}/.serverless'
          Contents: '**'
          TargetFolder: '$(Build.ArtifactStagingDirectory)/${{stage}}'
        displayName: 'Copy contents to /${{stage}}'

      - task: S3Upload@1
        inputs:
          awsCredentials: ${{parameters.awsCredentials}}
          regionName: ${{parameters.regionName}}
          bucketName: '${{parameters.productCode}}-artifacts-${{parameters.regionName}}'
          sourceFolder: $(Build.ArtifactStagingDirectory)
          globExpressions: '**'
          targetFolder: '${{parameters.solutionRoot}}/$(Build.SourceVersion)'

      - publish: $(Build.ArtifactStagingDirectory)/${{stage}}
        artifact: ${{parameters.artifactName}}${{stage}}