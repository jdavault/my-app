parameters:
  artifactName: ''
  buildConfiguration: Release
  awsCredentials: ''
  productCode: ''
  projectName: ''
  projectRoot: ''
  regionName: ''

steps:
  - script: dotnet restore
    workingDirectory:  ${{parameters.projectRoot}}
    displayName: 'dotnet restore'

  - task: DotNetCoreCLI@2
    inputs:
      command: 'build'
      arguments: '-c ${{parameters.buildConfiguration}}'
      projects: ${{parameters.projectRoot}}
    displayName: 'dotnet build'

  # TODO: Run unit tests

  - task: DotNetCoreCLI@2
    inputs:
      command: 'pack'
      packagesToPack: '$(Build.SourcesDirectory)/${{parameters.projectRoot}}/**/*.csproj'
      configuration: '${{parameters.buildConfiguration}}'
      packDirectory: $(Build.ArtifactStagingDirectory)
      versioningScheme: 'off'
    displayName: 'dotnet pack'

  - task: S3Upload@1
    inputs:
      awsCredentials: ${{parameters.awsCredentials}}
      regionName: ${{parameters.regionName}}
      bucketName: '${{parameters.productCode}}-artifacts-${{parameters.regionName}}'
      sourceFolder: $(Build.ArtifactStagingDirectory)
      globExpressions: '**'
      targetFolder: '${{parameters.projectName}}/$(Build.SourceVersion)'

  - publish: $(Build.ArtifactStagingDirectory)
    artifact: ${{parameters.artifactName}}